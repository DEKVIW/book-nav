# å‘é‡ç´¢å¼•ç”ŸæˆæŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•ä¸ºç½‘ç«™æ•°æ®ç”Ÿæˆå‘é‡ç´¢å¼•ï¼ŒåŒ…æ‹¬ï¼š
1. **æ‰¹é‡ç”Ÿæˆ**ï¼šä¸ºæ•°æ®åº“ä¸­æ‰€æœ‰ç°æœ‰ç½‘ç«™ç”Ÿæˆå‘é‡
2. **è‡ªåŠ¨è§¦å‘**ï¼šæ·»åŠ /ä¿®æ”¹ç½‘ç«™æ—¶è‡ªåŠ¨ç”Ÿæˆå‘é‡

---

## ä¸€ã€æ‰¹é‡ç”Ÿæˆå‘é‡ï¼ˆé€‚ç”¨äºå·²æœ‰å¤§é‡æ•°æ®ï¼‰

### 1.1 ä½¿ç”¨æ‰¹é‡ç”Ÿæˆè„šæœ¬

å·²åˆ›å»º `batch_generate_vectors.py` è„šæœ¬ï¼Œç”¨äºä¸ºæ‰€æœ‰ç°æœ‰ç½‘ç«™ç”Ÿæˆå‘é‡ã€‚

#### åŸºæœ¬ä½¿ç”¨

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
python batch_generate_vectors.py
```

#### åŠŸèƒ½ç‰¹æ€§

- âœ… **è‡ªåŠ¨è·³è¿‡å·²å­˜åœ¨çš„å‘é‡**ï¼ˆé»˜è®¤è¡Œä¸ºï¼Œé¿å…é‡å¤ç”Ÿæˆï¼‰
- âœ… **æ˜¾ç¤ºè¯¦ç»†è¿›åº¦**ï¼ˆæ¯10ä¸ªç½‘ç«™æ˜¾ç¤ºä¸€æ¬¡ï¼‰
- âœ… **é”™è¯¯å¤„ç†**ï¼ˆå•ä¸ªç½‘ç«™å¤±è´¥ä¸å½±å“æ•´ä½“ï¼‰
- âœ… **ç»Ÿè®¡ä¿¡æ¯**ï¼ˆæˆåŠŸ/è·³è¿‡/å¤±è´¥æ•°é‡ï¼‰

#### é«˜çº§é€‰é¡¹

```bash
# å¼ºåˆ¶é‡æ–°ç”Ÿæˆæ‰€æœ‰å‘é‡ï¼ˆä¸è·³è¿‡å·²å­˜åœ¨çš„ï¼‰
python batch_generate_vectors.py --no-skip

# è‡ªå®šä¹‰è¿›åº¦æ˜¾ç¤ºæ‰¹æ¬¡å¤§å°
python batch_generate_vectors.py --batch-size 20
```

#### æ‰§è¡Œæµç¨‹

```
1. æ£€æŸ¥é…ç½®ï¼ˆAPIåœ°å€ã€å¯†é’¥ã€æ¨¡å‹ã€Qdrantåœ°å€ï¼‰
2. åˆå§‹åŒ–å‘é‡æœåŠ¡
3. è·å–æ‰€æœ‰ç½‘ç«™
4. æ£€æŸ¥å·²å­˜åœ¨çš„å‘é‡ï¼ˆå¯é€‰ï¼‰
5. éå†æ‰€æœ‰ç½‘ç«™ï¼Œç”Ÿæˆå‘é‡
6. æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
```

#### è¾“å‡ºç¤ºä¾‹

```
ğŸ“‹ é…ç½®ä¿¡æ¯ï¼š
   APIåœ°å€: http://localhost:11434
   Embeddingæ¨¡å‹: bge-large-zh-v1.5
   Qdrantåœ°å€: http://localhost:6333

âœ… å‘é‡æœåŠ¡åˆå§‹åŒ–æˆåŠŸï¼ˆç»´åº¦: 1024ï¼‰

ğŸ“Š æ‰¾åˆ° 1000 ä¸ªç½‘ç«™
ğŸ” æ£€æŸ¥å·²å­˜åœ¨çš„å‘é‡...
   âœ… å‘ç° 200 ä¸ªç½‘ç«™å·²æœ‰å‘é‡ï¼Œå°†è·³è¿‡

ğŸš€ å¼€å§‹ç”Ÿæˆå‘é‡...
============================================================
[10/1000] âœ… GitHub - ä»£ç æ‰˜ç®¡å¹³å° - å‘é‡ç”ŸæˆæˆåŠŸ
[20/1000] âœ… åšå®¢å›­ - ç¨‹åºå‘˜åšå®¢ - å‘é‡ç”ŸæˆæˆåŠŸ
...
============================================================
ğŸ“Š å‘é‡ç”Ÿæˆå®Œæˆï¼
   âœ… æˆåŠŸ: 800
   â­ï¸  è·³è¿‡: 200
   âŒ å¤±è´¥: 0
   ğŸ“ˆ æ€»è®¡: 1000
============================================================
```

---

## äºŒã€è‡ªåŠ¨è§¦å‘å‘é‡ç”Ÿæˆï¼ˆå·²å®ç°ï¼‰

### 2.1 è§¦å‘æ—¶æœº

ä»¥ä¸‹æ“ä½œä¼šè‡ªåŠ¨è§¦å‘å‘é‡ç”Ÿæˆï¼š

#### âœ… æ·»åŠ ç½‘ç«™æ—¶

1. **åå°ç®¡ç† - æ·»åŠ ç½‘ç«™** (`app/admin/websites.py`)
   ```python
   @bp.route('/website/add', methods=['GET', 'POST'])
   def add_website():
       # ... æ·»åŠ ç½‘ç«™ ...
       # å¼‚æ­¥ç”Ÿæˆå‘é‡
       trigger_vector_indexing(website.id, category_name)
   ```

2. **API - å¿«é€Ÿæ·»åŠ ç½‘ç«™** (`app/main/api_website.py`)
   ```python
   @bp.route('/api/website/quick-add', methods=['POST'])
   def quick_add_website():
       # ... æ·»åŠ ç½‘ç«™ ...
       # å¼‚æ­¥ç”Ÿæˆå‘é‡
       _trigger_vector_indexing(website.id, category_name)
   ```

#### âœ… ä¿®æ”¹ç½‘ç«™æ—¶

1. **åå°ç®¡ç† - ç¼–è¾‘ç½‘ç«™** (`app/admin/websites.py`)
   ```python
   @bp.route('/website/edit/<int:id>', methods=['GET', 'POST'])
   def edit_website(id):
       # ... æ›´æ–°ç½‘ç«™ ...
       # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°å‘é‡
       needs_vector_update = (
           old_title != website.title or
           old_description != website.description or
           old_category_id != website.category_id
       )
       if needs_vector_update:
           trigger_vector_indexing(website.id, new_category_name)
   ```

2. **API - æ›´æ–°ç½‘ç«™** (`app/main/api_website.py`)
   ```python
   @bp.route('/api/website/<int:site_id>/update', methods=['POST'])
   def update_website(site_id):
       # ... æ›´æ–°ç½‘ç«™ ...
       if needs_vector_update:
           _trigger_vector_indexing(website.id, new_category_name)
   ```

3. **API - ä¿®æ”¹é“¾æ¥** (`app/main/api_website.py`)
   ```python
   @bp.route('/api/modify_link', methods=['POST'])
   def api_modify_link():
       # ... ä¿®æ”¹é“¾æ¥ ...
       if needs_vector_update:
           _trigger_vector_indexing(website.id, category_name)
   ```

### 2.2 è§¦å‘æ¡ä»¶

å‘é‡ç”Ÿæˆåªåœ¨ä»¥ä¸‹æƒ…å†µè§¦å‘ï¼š

- âœ… **æ ‡é¢˜å˜åŒ–**
- âœ… **æè¿°å˜åŒ–**
- âœ… **åˆ†ç±»å˜åŒ–**

**ä¸ä¼šè§¦å‘çš„æƒ…å†µï¼š**
- âŒ ä»…ä¿®æ”¹URLï¼ˆä¸å½±å“æœç´¢å†…å®¹ï¼‰
- âŒ ä»…ä¿®æ”¹å›¾æ ‡
- âŒ ä»…ä¿®æ”¹æ’åºæƒé‡
- âŒ ä»…ä¿®æ”¹ç§æœ‰/æ¨èçŠ¶æ€

### 2.3 å®ç°æœºåˆ¶

#### å¼‚æ­¥åå°æ‰§è¡Œ

å‘é‡ç”Ÿæˆåœ¨**åå°çº¿ç¨‹**ä¸­æ‰§è¡Œï¼Œä¸ä¼šé˜»å¡ä¸»æµç¨‹ï¼š

```python
def _trigger_vector_indexing(website_id: int, category_name: str = None):
    """å¼‚æ­¥è§¦å‘å‘é‡ç”Ÿæˆï¼ˆåå°çº¿ç¨‹æ‰§è¡Œï¼Œä¸é˜»å¡ä¸»æµç¨‹ï¼‰"""
    def _generate_vector_in_background():
        # åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œå‘é‡ç”Ÿæˆ
        with current_app.app_context():
            # ... ç”Ÿæˆå‘é‡ ...
    
    # å¯åŠ¨åå°çº¿ç¨‹
    thread = threading.Thread(target=_generate_vector_in_background, daemon=True)
    thread.start()
```

#### é…ç½®æ£€æŸ¥

å‘é‡ç”Ÿæˆå‰ä¼šæ£€æŸ¥é…ç½®æ˜¯å¦å®Œæ•´ï¼š

```python
# æ£€æŸ¥å‘é‡æœç´¢æ˜¯å¦å¯ç”¨
if not (settings and settings.vector_search_enabled and 
        all([settings.qdrant_url, settings.embedding_model, 
             settings.ai_api_base_url, settings.ai_api_key])):
    return  # é…ç½®ä¸å®Œæ•´ï¼Œä¸ç”Ÿæˆå‘é‡
```

---

## ä¸‰ã€ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šæ–°éƒ¨ç½²é¡¹ç›®ï¼ˆæ•°æ®åº“å·²æœ‰æ•°æ®ï¼‰

```bash
# 1. é…ç½®AIæœç´¢å’Œå‘é‡æœç´¢ï¼ˆåå°ç®¡ç† â†’ ç«™ç‚¹è®¾ç½®ï¼‰
# 2. è¿è¡Œæ‰¹é‡ç”Ÿæˆè„šæœ¬
python batch_generate_vectors.py

# 3. åç»­æ·»åŠ /ä¿®æ”¹ç½‘ç«™ä¼šè‡ªåŠ¨ç”Ÿæˆå‘é‡
```

### åœºæ™¯2ï¼šä»å…¶ä»–ç³»ç»Ÿè¿ç§»æ•°æ®

```bash
# 1. å¯¼å…¥æ•°æ®ï¼ˆåå°ç®¡ç† â†’ æ•°æ®ç®¡ç†ï¼‰
# 2. è¿è¡Œæ‰¹é‡ç”Ÿæˆè„šæœ¬
python batch_generate_vectors.py

# 3. åç»­æ“ä½œè‡ªåŠ¨è§¦å‘
```

### åœºæ™¯3ï¼šæ›´æ¢Embeddingæ¨¡å‹

```bash
# 1. åœ¨åå°ç®¡ç†ä¿®æ”¹Embeddingæ¨¡å‹
# 2. é‡æ–°ç”Ÿæˆæ‰€æœ‰å‘é‡ï¼ˆå¼ºåˆ¶æ¨¡å¼ï¼‰
python batch_generate_vectors.py --no-skip
```

### åœºæ™¯4ï¼šæ—¥å¸¸ä½¿ç”¨

- âœ… æ·»åŠ ç½‘ç«™ â†’ è‡ªåŠ¨ç”Ÿæˆå‘é‡
- âœ… ä¿®æ”¹ç½‘ç«™æ ‡é¢˜/æè¿°/åˆ†ç±» â†’ è‡ªåŠ¨æ›´æ–°å‘é‡
- âœ… æ— éœ€æ‰‹åŠ¨æ“ä½œ

---

## å››ã€æ³¨æ„äº‹é¡¹

### 4.1 æ€§èƒ½è€ƒè™‘

- **æ‰¹é‡ç”Ÿæˆ**ï¼šå¤§é‡æ•°æ®æ—¶å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´
  - 1000ä¸ªç½‘ç«™ â‰ˆ 10-30åˆ†é’Ÿï¼ˆå–å†³äºAPIé€Ÿåº¦ï¼‰
  - å»ºè®®åœ¨ä½å³°æœŸæ‰§è¡Œ

- **è‡ªåŠ¨è§¦å‘**ï¼šåå°å¼‚æ­¥æ‰§è¡Œï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
  - å•ä¸ªå‘é‡ç”Ÿæˆï¼š200-500ms
  - ä¸é˜»å¡ç½‘ç«™æ·»åŠ /ä¿®æ”¹æ“ä½œ

### 4.2 é”™è¯¯å¤„ç†

- **æ‰¹é‡ç”Ÿæˆ**ï¼šå•ä¸ªç½‘ç«™å¤±è´¥ä¸å½±å“å…¶ä»–ç½‘ç«™
- **è‡ªåŠ¨è§¦å‘**ï¼šå¤±è´¥åªè®°å½•æ—¥å¿—ï¼Œä¸å½±å“ä¸»æµç¨‹
- **æŸ¥çœ‹æ—¥å¿—**ï¼šæ£€æŸ¥ `current_app.logger` è¾“å‡º

### 4.3 é…ç½®è¦æ±‚

å‘é‡ç”Ÿæˆéœ€è¦ä»¥ä¸‹é…ç½®ï¼š

- âœ… å‘é‡æœç´¢å·²å¯ç”¨
- âœ… Qdrant URL å·²é…ç½®
- âœ… Embedding æ¨¡å‹å·²é…ç½®
- âœ… AI API åœ°å€å’Œå¯†é’¥å·²é…ç½®

---

## äº”ã€ä»£ç ä½ç½®æ€»ç»“

### æ‰¹é‡ç”Ÿæˆè„šæœ¬
- `batch_generate_vectors.py` - æ‰¹é‡ç”Ÿæˆè„šæœ¬

### è‡ªåŠ¨è§¦å‘å®ç°
- `app/main/api_website.py` - APIæ¥å£çš„å‘é‡è§¦å‘
  - `quick_add_website()` - å¿«é€Ÿæ·»åŠ 
  - `update_website()` - æ›´æ–°ç½‘ç«™
  - `api_modify_link()` - ä¿®æ”¹é“¾æ¥
  - `_trigger_vector_indexing()` - è§¦å‘å‡½æ•°

- `app/admin/websites.py` - åå°ç®¡ç†çš„å‘é‡è§¦å‘
  - `add_website()` - æ·»åŠ ç½‘ç«™
  - `edit_website()` - ç¼–è¾‘ç½‘ç«™

- `app/admin/utils.py` - å·¥å…·å‡½æ•°
  - `trigger_vector_indexing()` - è§¦å‘å‡½æ•°ï¼ˆåå°ç®¡ç†ä½¿ç”¨ï¼‰

### å‘é‡æœåŠ¡
- `app/utils/vector_service.py` - å‘é‡æœåŠ¡æ ¸å¿ƒ
  - `EmbeddingClient` - Embedding APIå®¢æˆ·ç«¯
  - `QdrantVectorStore` - Qdrantå­˜å‚¨å®¢æˆ·ç«¯
  - `VectorSearchService` - å‘é‡æœç´¢æœåŠ¡

---

## å…­ã€å¸¸è§é—®é¢˜

### Q1: æ‰¹é‡ç”Ÿæˆæ—¶å¦‚ä½•æŸ¥çœ‹è¿›åº¦ï¼Ÿ

A: è„šæœ¬ä¼šæ¯10ä¸ªç½‘ç«™æ˜¾ç¤ºä¸€æ¬¡è¿›åº¦ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ `--batch-size` å‚æ•°è°ƒæ•´æ˜¾ç¤ºé¢‘ç‡ã€‚

### Q2: æ‰¹é‡ç”Ÿæˆä¸­æ–­äº†æ€ä¹ˆåŠï¼Ÿ

A: è„šæœ¬é»˜è®¤è·³è¿‡å·²å­˜åœ¨çš„å‘é‡ï¼Œé‡æ–°è¿è¡Œä¼šç»§ç»­å¤„ç†æœªç”Ÿæˆçš„ç½‘ç«™ã€‚

### Q3: å¦‚ä½•å¼ºåˆ¶é‡æ–°ç”Ÿæˆæ‰€æœ‰å‘é‡ï¼Ÿ

A: ä½¿ç”¨ `--no-skip` å‚æ•°ï¼š
```bash
python batch_generate_vectors.py --no-skip
```

### Q4: è‡ªåŠ¨è§¦å‘å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

A: æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ï¼Œç¡®è®¤ï¼š
- APIé…ç½®æ˜¯å¦æ­£ç¡®
- QdrantæœåŠ¡æ˜¯å¦è¿è¡Œ
- ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸

### Q5: å¦‚ä½•éªŒè¯å‘é‡æ˜¯å¦ç”ŸæˆæˆåŠŸï¼Ÿ

A: å¯ä»¥é€šè¿‡æœç´¢åŠŸèƒ½æµ‹è¯•ï¼Œå¦‚æœå‘é‡æœç´¢è¿”å›ç»“æœï¼Œè¯´æ˜å‘é‡å·²ç”Ÿæˆã€‚

---

## ä¸ƒã€æ€»ç»“

### âœ… å·²å®ç°çš„åŠŸèƒ½

1. **æ‰¹é‡ç”Ÿæˆè„šæœ¬** - ä¸ºæ‰€æœ‰ç°æœ‰ç½‘ç«™ç”Ÿæˆå‘é‡
2. **è‡ªåŠ¨è§¦å‘æœºåˆ¶** - æ·»åŠ /ä¿®æ”¹ç½‘ç«™æ—¶è‡ªåŠ¨ç”Ÿæˆå‘é‡
3. **æ™ºèƒ½åˆ¤æ–­** - åªåœ¨å†…å®¹å˜åŒ–æ—¶è§¦å‘
4. **å¼‚æ­¥æ‰§è¡Œ** - ä¸é˜»å¡ä¸»æµç¨‹
5. **é”™è¯¯å¤„ç†** - å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

### ğŸ“ ä½¿ç”¨å»ºè®®

1. **é¦–æ¬¡éƒ¨ç½²**ï¼šè¿è¡Œæ‰¹é‡ç”Ÿæˆè„šæœ¬
2. **æ—¥å¸¸ä½¿ç”¨**ï¼šä¾èµ–è‡ªåŠ¨è§¦å‘æœºåˆ¶
3. **æ¨¡å‹æ›´æ¢**ï¼šä½¿ç”¨ `--no-skip` é‡æ–°ç”Ÿæˆ
4. **ç›‘æ§æ—¥å¿—**ï¼šå®šæœŸæ£€æŸ¥é”™è¯¯æ—¥å¿—

