{% extends "admin/base.html" %} {% block admin_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2><i class="bi bi-gear"></i> 站点设置</h2>
</div>

<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <i class="bi bi-gear me-1"></i>
    站点设置
  </div>
  <div class="card-body">
    <!-- 标签页导航 -->
    <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link active"
          id="basic-tab"
          data-bs-toggle="tab"
          data-bs-target="#basic"
          type="button"
          role="tab"
          aria-controls="basic"
          aria-selected="true"
        >
          <i class="bi bi-info-circle me-1"></i> 基本设置
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="background-tab"
          data-bs-toggle="tab"
          data-bs-target="#background"
          type="button"
          role="tab"
          aria-controls="background"
          aria-selected="false"
        >
          <i class="bi bi-palette me-1"></i> 背景设置
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="transition-tab"
          data-bs-toggle="tab"
          data-bs-target="#transition"
          type="button"
          role="tab"
          aria-controls="transition"
          aria-selected="false"
        >
          <i class="bi bi-box-arrow-up-right me-1"></i> 过渡页设置
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="ai-search-tab"
          data-bs-toggle="tab"
          data-bs-target="#ai-search"
          type="button"
          role="tab"
          aria-controls="ai-search"
          aria-selected="false"
        >
          <i class="bi bi-robot me-1"></i> AI搜索设置
        </button>
      </li>
    </ul>

    <form method="post" enctype="multipart/form-data">
      {{ form.hidden_tag() }}
      <!-- 添加隐藏字段用于标记清空操作 -->
      <input type="hidden" name="clear_logo" id="clear_logo_field" value="0" />
      <input
        type="hidden"
        name="clear_favicon"
        id="clear_favicon_field"
        value="0"
      />

      <!-- 标签页内容 -->
      <div class="tab-content" id="settingsTabsContent">
        <!-- 基本设置标签页 -->
        <div
          class="tab-pane fade show active"
          id="basic"
          role="tabpanel"
          aria-labelledby="basic-tab"
        >
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="bi bi-info-circle me-2"></i>网站基本信息设置
              </h5>
              <p class="text-muted small mb-0">
                设置网站的基本信息，如名称、副标题、Logo、Favicon和SEO相关内容
              </p>
            </div>
            <div class="card-body">
              <div class="row mb-4">
                <div class="col-md-6">
                  <div class="mb-3">
                    {{ form.site_name.label(class="form-label fw-bold") }} {{
                    form.site_name(class="form-control") }} {% if
                    form.site_name.errors %} {% for error in
                    form.site_name.errors %}
                    <div class="text-danger">{{ error }}</div>
                    {% endfor %} {% endif %}
                    <div class="form-text">
                      网站标题将显示在浏览器标签和导航栏
                    </div>
                  </div>
                  <div class="mb-3">
                    {{ form.site_subtitle.label(class="form-label fw-bold") }}
                    {{ form.site_subtitle(class="form-control") }}
                    <div class="form-text">副标题可显示在网站首页或页脚</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    {{ form.site_keywords.label(class="form-label fw-bold") }}
                    {{ form.site_keywords(class="form-control") }}
                    <div class="form-text">
                      用于SEO，多个关键词之间用英文逗号分隔
                    </div>
                  </div>
                  <div class="mb-3">
                    {{ form.site_description.label(class="form-label fw-bold")
                    }} {{ form.site_description(class="form-control", rows=1,
                    style="resize:none;") }}
                    <div class="form-text">网站描述用于SEO和社交媒体分享</div>
                  </div>
                </div>
              </div>
              <!-- Logo和Favicon并排布局，宽度与上方两列对齐 -->
              <div class="row mb-3">
                <div class="col-md-6 col-12">
                  <label class="form-label fw-bold">网站Logo</label>
                  <div
                    class="d-flex align-items-center mb-2"
                    style="height: 50px"
                  >
                    <div class="site-logo-preview me-3">
                      {% if settings.site_logo and settings.site_logo != "" %}
                      <img
                        src="{{ settings.site_logo }}"
                        alt="网站Logo"
                        style="max-height: 50px"
                        onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-center p-3 bg-light rounded\'><i class=\'bi bi-collection\'></i> 默认Logo</div>';"
                      />
                      {% else %}
                      <div class="text-center p-3 bg-light rounded">
                        <i class="bi bi-collection"></i> 默认Logo
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="input-group mb-2">
                    <span class="input-group-text"
                      ><i class="bi bi-link-45deg"></i
                    ></span>
                    {% set logo_placeholder = "Logo URL" %} {{
                    form.site_logo(class="form-control",
                    placeholder=logo_placeholder) }}
                    <button
                      class="btn btn-outline-secondary clear-input"
                      type="button"
                      data-target="site_logo"
                      data-preview="site-logo-preview"
                    >
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>
                  <div class="form-text mb-2">外部图床URL或相对路径</div>
                  <div class="input-group">
                    <span class="input-group-text"
                      ><i class="bi bi-upload"></i
                    ></span>
                    {{ form.logo_file(class="form-control") }}
                    <button
                      class="btn btn-outline-secondary clear-input"
                      type="button"
                      data-target="logo_file"
                      data-preview="site-logo-preview"
                    >
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>
                  <div class="form-text">或直接上传图片（优先使用上传）</div>
                </div>
                <div class="col-md-6 col-12">
                  <label class="form-label fw-bold">网站图标</label>
                  <div
                    class="d-flex align-items-center mb-2"
                    style="height: 50px"
                  >
                    <div class="favicon-preview me-3">
                      {% if settings.site_favicon and settings.site_favicon !=
                      "" %}
                      <img
                        src="{{ settings.site_favicon }}"
                        alt="网站图标"
                        style="max-height: 32px"
                        onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-center p-3 bg-light rounded\' style=\'width: 32px; height: 32px\'><i class=\'bi bi-globe\' style=\'font-size: 16px\'></i></div>';"
                      />
                      {% else %}
                      <div
                        class="text-center p-3 bg-light rounded"
                        style="width: 32px; height: 32px"
                      >
                        <i class="bi bi-globe" style="font-size: 16px"></i>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="input-group mb-2">
                    <span class="input-group-text"
                      ><i class="bi bi-link-45deg"></i
                    ></span>
                    {{ form.site_favicon(class="form-control",
                    placeholder="Favicon URL") }}
                    <button
                      class="btn btn-outline-secondary clear-input"
                      type="button"
                      data-target="site_favicon"
                      data-preview="favicon-preview"
                    >
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>
                  <div class="form-text mb-2">外部图床URL或相对路径</div>
                  <div class="input-group">
                    <span class="input-group-text"
                      ><i class="bi bi-upload"></i
                    ></span>
                    {{ form.favicon_file(class="form-control") }}
                    <button
                      class="btn btn-outline-secondary clear-input"
                      type="button"
                      data-target="favicon_file"
                      data-preview="favicon-preview"
                    >
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>
                  <div class="form-text">或直接上传图片（优先使用上传）</div>
                </div>
              </div>

              <div class="mb-4">
                <label class="form-label fw-bold"
                  >{{ form.footer_content.label }}</label
                >
                {{ form.footer_content(class="form-control", rows=4) }}
                <div class="form-text">
                  支持HTML，可自定义页脚内容，如版权信息、备案号、友情链接等
                </div>
              </div>

              <!-- 弹窗公告设置区域 -->
              <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light">
                  <h5 class="mb-0">
                    <i class="bi bi-megaphone me-2"></i>弹窗公告设置
                  </h5>
                  <p class="text-muted small mb-0">
                    可用于重要通知（如更换域名、维护公告等），开启后将在首页以弹窗形式展示。
                  </p>
                </div>
                <div class="card-body">
                  <div class="form-check form-switch mb-3">
                    {{ form.announcement_enabled(class="form-check-input") }}
                    <label class="form-check-label" for="announcement_enabled">
                      {% if settings.announcement_enabled %}已启用{% else
                      %}未启用{% endif %}
                    </label>
                  </div>
                  <div class="mb-3">
                    {{ form.announcement_title.label(class="form-label fw-bold")
                    }} {{ form.announcement_title(class="form-control") }}
                    <div class="form-text">可选，显示在弹窗顶部</div>
                  </div>
                  <div class="mb-3">
                    {{ form.announcement_content.label(class="form-label
                    fw-bold") }} {{
                    form.announcement_content(class="form-control", rows=3) }}
                    <div class="form-text">必填，支持换行</div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      {{ form.announcement_start.label(class="form-label
                      fw-bold") }} {{
                      form.announcement_start(class="form-control",
                      type="datetime-local") }}
                      <div class="form-text">可选，公告开始时间</div>
                    </div>
                    <div class="col-md-6 mb-3">
                      {{ form.announcement_end.label(class="form-label fw-bold")
                      }} {{ form.announcement_end(class="form-control",
                      type="datetime-local") }}
                      <div class="form-text">可选，公告结束时间</div>
                    </div>
                  </div>
                  <div class="mb-3">
                    {{ form.announcement_remember_days.label(class="form-label
                    fw-bold") }} {{
                    form.announcement_remember_days(class="form-control",
                    type="number", min="1", max="365") }}
                    <div class="form-text">
                      用户点击"不再显示"后，多少天内不再显示公告（1-365天）
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 背景设置标签页 -->
        <div
          class="tab-pane fade"
          id="background"
          role="tabpanel"
          aria-labelledby="background-tab"
        >
          <div class="card shadow-sm border-0 mb-4">
            <div
              class="card-header bg-light d-flex justify-content-between align-items-center"
            >
              <h5 class="mb-0">
                <i class="bi bi-palette me-2"></i>网站背景设置
              </h5>
              <a
                href="{{ url_for('admin.wallpaper') }}"
                class="btn btn-outline-primary btn-sm"
              >
                <i class="bi bi-images me-1"></i> 背景管理
              </a>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- PC端设置 -->
                <div class="col-md-6 border-end">
                  <h6 class="fw-bold mb-3">
                    <i class="bi bi-laptop me-1"></i>PC端背景
                  </h6>
                  <div class="mb-3">
                    {{ form.pc_background_type.label(class="form-label fw-bold")
                    }} {{ form.pc_background_type(class="form-control") }}
                    <div class="form-text">选择PC端背景类型</div>
                  </div>
                  <div class="mb-3">
                    {{ form.pc_background_url.label(class="form-label fw-bold")
                    }} {{ form.pc_background_url(class="form-control") }}
                    <div class="form-text">背景URL或颜色代码</div>
                  </div>
                  <div class="mb-3">
                    {{ form.pc_background_file.label(class="form-label fw-bold")
                    }} {{ form.pc_background_file(class="form-control") }}
                    <div class="form-text">上传背景图片（优先使用上传）</div>
                  </div>
                  <div
                    class="bg-preview p-3 bg-light rounded text-center mt-3"
                    id="pcBgPreview"
                    style="height: 120px"
                  >
                    <p class="mb-0">PC端背景预览</p>
                  </div>
                </div>
                <!-- 移动端设置 -->
                <div class="col-md-6">
                  <h6 class="fw-bold mb-3">
                    <i class="bi bi-phone me-1"></i>移动端背景
                  </h6>
                  <div class="mb-3">
                    {{ form.mobile_background_type.label(class="form-label
                    fw-bold") }} {{
                    form.mobile_background_type(class="form-control") }}
                    <div class="form-text">选择移动端背景类型</div>
                  </div>
                  <div class="mb-3">
                    {{ form.mobile_background_url.label(class="form-label
                    fw-bold") }} {{
                    form.mobile_background_url(class="form-control") }}
                    <div class="form-text">背景URL或颜色代码</div>
                  </div>
                  <div class="mb-3">
                    {{ form.mobile_background_file.label(class="form-label
                    fw-bold") }} {{
                    form.mobile_background_file(class="form-control") }}
                    <div class="form-text">上传背景图片（优先使用上传）</div>
                  </div>
                  <div
                    class="bg-preview p-3 bg-light rounded text-center mt-3"
                    id="mobileBgPreview"
                    style="height: 120px"
                  >
                    <p class="mb-0">移动端背景预览</p>
                  </div>
                </div>
              </div>
              <div class="alert alert-info mt-4">
                <i class="bi bi-info-circle me-2"></i>
                <strong>背景类型说明：</strong>
                <ul class="mb-0 mt-2">
                  <li><strong>无背景</strong> - 使用系统默认背景</li>
                  <li>
                    <strong>图片背景</strong> - 可上传自定义图片或使用外部链接
                  </li>
                  <li>
                    <strong>渐变色背景</strong> - 使用CSS渐变代码，如
                    linear-gradient(135deg, #6e8efb, #a777e3)
                  </li>
                  <li>
                    <strong>纯色背景</strong> - 使用颜色代码，如 #f5f7fa 或
                    rgba(245, 247, 250, 1)
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- 过渡页设置标签页 -->
        <div
          class="tab-pane fade"
          id="transition"
          role="tabpanel"
          aria-labelledby="transition-tab"
        >
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="bi bi-box-arrow-up-right me-2"></i>过渡页设置
              </h5>
              <p class="text-muted small mb-0">配置网站链接跳转时的过渡页面</p>
            </div>
            <div class="card-body">
              <!-- 启用开关 -->
              <div class="mb-4">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <label class="form-label fw-bold mb-0">过渡页</label>
                  <div class="form-check form-switch">
                    {{ form.enable_transition(class="form-check-input") }}
                    <label class="form-check-label" for="enable_transition">
                      {% if settings.enable_transition %}启用{% else %}关闭{%
                      endif %}
                    </label>
                  </div>
                </div>
                <div class="form-text">
                  启用后，点击网站链接时会先显示过渡页
                </div>
              </div>

              <!-- 停留时间设置 -->
              <div class="row mb-4">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label fw-bold">访客停留时间</label>
                    <div class="input-group">
                      {{ form.transition_time(class="form-control",
                      type="number", min=0, max=30) }}
                      <span class="input-group-text">秒</span>
                    </div>
                    <div class="form-text">
                      访客查看过渡页的停留时间（设置为0则不显示过渡页直接跳转）
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label fw-bold">管理员停留时间</label>
                    <div class="input-group">
                      {{ form.admin_transition_time(class="form-control",
                      type="number", min=0, max=30) }}
                      <span class="input-group-text">秒</span>
                    </div>
                    <div class="form-text">
                      管理员查看过渡页的停留时间（设置为0则不显示过渡页直接跳转）
                    </div>
                  </div>
                </div>
              </div>

              <!-- 显示选项 -->
              <div class="mb-4">
                <label class="form-label fw-bold">显示选项</label>
                <div class="card bg-light">
                  <div class="card-body">
                    <div class="mb-3 form-check">
                      {{
                      form.transition_remember_choice(class="form-check-input")
                      }}
                      <label
                        class="form-check-label"
                        for="transition_remember_choice"
                      >
                        允许用户选择不再显示过渡页
                      </label>
                      <div class="form-text">
                        启用后，用户可以选择跳过过渡页
                      </div>
                    </div>
                    <div class="mb-3 form-check">
                      {{
                      form.transition_show_description(class="form-check-input")
                      }}
                      <label
                        class="form-check-label"
                        for="transition_show_description"
                      >
                        显示网站描述
                      </label>
                      <div class="form-text">在过渡页中显示网站的描述信息</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 主题设置 -->
              <div class="mb-4">
                <label class="form-label fw-bold">主题设置</label>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">主题风格</label>
                      {{ form.transition_theme(class="form-select") }}
                      <div class="form-text">选择过渡页的主题样式</div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">主色调</label>
                      <div class="input-group">
                        <span class="input-group-text"
                          ><i class="bi bi-palette"></i
                        ></span>
                        {{ form.transition_color(class="form-control",
                        type="color") }}
                      </div>
                      <div class="form-text">设置过渡页的主要颜色</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 广告设置 -->
              <div class="mb-3">
                <label class="form-label fw-bold">广告1</label>
                {{ form.transition_ad1(class="form-control", rows=4) }}
                <div class="form-text">支持HTML代码，显示在过渡页中</div>
              </div>

              <div class="mb-3">
                <label class="form-label fw-bold">广告2</label>
                {{ form.transition_ad2(class="form-control", rows=4) }}
                <div class="form-text">支持HTML代码，显示在过渡页底部</div>
              </div>
            </div>
          </div>
        </div>

        <!-- AI搜索设置标签页 -->
        <div
          class="tab-pane fade"
          id="ai-search"
          role="tabpanel"
          aria-labelledby="ai-search-tab"
        >
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="bi bi-robot me-2"></i>AI智能搜索设置
              </h5>
              <p class="text-muted small mb-0">
                配置AI搜索功能，让搜索更智能、更精准。支持OpenAI API及兼容服务。
              </p>
            </div>
            <div class="card-body">
              <!-- 两列布局 -->
              <div class="row">
                <!-- 左列：AI搜索API配置 -->
                <div class="col-md-6">
                  <h6 class="mb-3">
                    <i class="bi bi-robot me-2"></i>AI搜索API配置
                  </h6>

                  <!-- 启用开关 -->
                  <div class="mb-4">
                    <div
                      class="d-flex justify-content-between align-items-center mb-2"
                    >
                      <label class="form-label fw-bold mb-0">启用AI搜索</label>
                      <div class="form-check form-switch">
                        {{ form.ai_search_enabled(class="form-check-input") }}
                        <label class="form-check-label" for="ai_search_enabled">
                          {% if settings.ai_search_enabled %}已启用{% else
                          %}已关闭{% endif %}
                        </label>
                      </div>
                    </div>
                    <div class="form-text">
                      启用后，用户可以在搜索时使用AI智能搜索功能
                    </div>
                  </div>

                  <!-- 允许非登录用户使用AI搜索 -->
                  <div class="mb-3">
                    <div
                      class="d-flex justify-content-between align-items-center mb-2"
                    >
                      <label class="form-label fw-bold mb-0"
                        >允许非登录用户使用AI搜索</label
                      >
                      <div class="form-check form-switch">
                        {{
                        form.ai_search_allow_anonymous(class="form-check-input",
                        id="ai_search_allow_anonymous") }}
                        <label
                          class="form-check-label"
                          for="ai_search_allow_anonymous"
                        >
                          {% if settings.ai_search_allow_anonymous %}已允许{%
                          else %}已禁止{% endif %}
                        </label>
                      </div>
                    </div>
                    <div class="form-text">
                      <i class="bi bi-info-circle me-1"></i>
                      开启后，未登录用户也可以使用AI搜索功能。关闭则仅允许登录用户使用。
                    </div>
                  </div>

                  <!-- API基础URL -->
                  <div class="mb-3">
                    <label class="form-label fw-bold">API基础URL</label>
                    {{ form.ai_api_base_url(class="form-control",
                    placeholder="https://api.openai.com") }} {% if
                    form.ai_api_base_url.errors %} {% for error in
                    form.ai_api_base_url.errors %}
                    <div class="text-danger">{{ error }}</div>
                    {% endfor %} {% endif %}
                    <div class="form-text">
                      例如: https://api.openai.com 或 https://api.example.com
                    </div>
                  </div>

                  <!-- API密钥 -->
                  <div class="mb-3">
                    <label class="form-label fw-bold">API密钥</label>
                    <input
                      type="password"
                      class="form-control"
                      id="ai_api_key"
                      name="ai_api_key"
                      placeholder="sk-..."
                      value="{{ form.ai_api_key.data if form.ai_api_key.data else '' }}"
                    />
                    {% if form.ai_api_key.errors %} {% for error in
                    form.ai_api_key.errors %}
                    <div class="text-danger">{{ error }}</div>
                    {% endfor %} {% endif %}
                    <div class="form-text">
                      {% if settings.ai_api_key %}
                      <span class="text-success"
                        ><i class="bi bi-check-circle me-1"></i
                        >已配置密钥（显示为掩码）</span
                      >，留空则不修改，输入新密钥则更新 {% else %}
                      留空则不修改现有密钥。请妥善保管您的API密钥。 {% endif %}
                    </div>
                  </div>

                  <!-- 模型名称 -->
                  <div class="mb-3">
                    <label class="form-label fw-bold">模型名称</label>
                    {{ form.ai_model_name(class="form-control",
                    placeholder="gpt-3.5-turbo") }} {% if
                    form.ai_model_name.errors %} {% for error in
                    form.ai_model_name.errors %}
                    <div class="text-danger">{{ error }}</div>
                    {% endfor %} {% endif %}
                    <div class="form-text">
                      例如: gpt-3.5-turbo, gpt-4, claude-3-sonnet
                    </div>
                  </div>

                  <!-- 温度参数和最大Token数 -->
                  <div class="row mb-3">
                    <div class="col-6">
                      <label class="form-label fw-bold">温度参数</label>
                      {{ form.ai_temperature(class="form-control",
                      placeholder="0.7", type="number", step="0.1", min="0",
                      max="1") }} {% if form.ai_temperature.errors %} {% for
                      error in form.ai_temperature.errors %}
                      <div class="text-danger">{{ error }}</div>
                      {% endfor %} {% endif %}
                      <div class="form-text small">0-1之间，默认0.7</div>
                    </div>
                    <div class="col-6">
                      <label class="form-label fw-bold">最大Token数</label>
                      {{ form.ai_max_tokens(class="form-control", type="number",
                      min="100", max="2000") }} {% if form.ai_max_tokens.errors
                      %} {% for error in form.ai_max_tokens.errors %}
                      <div class="text-danger">{{ error }}</div>
                      {% endfor %} {% endif %}
                      <div class="form-text small">建议500-1000</div>
                    </div>
                  </div>

                  <!-- 配置状态提示 -->
                  {% if settings.ai_api_base_url and settings.ai_api_key and
                  settings.ai_model_name %}
                  <div class="alert alert-success mb-3">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong>AI搜索已配置</strong>
                    <p class="mb-0 mt-2 small">
                      API密钥: {% if settings.ai_api_key|length > 8 %} {{
                      settings.ai_api_key[:4] }}****{{ settings.ai_api_key[-4:]
                      }} {% else %} **** {% endif %}
                    </p>
                  </div>
                  {% else %}
                  <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>AI搜索未完整配置</strong>
                    <p class="mb-0 mt-2 small">
                      请填写API基础URL、API密钥和模型名称
                    </p>
                  </div>
                  {% endif %}

                  <!-- 测试按钮 -->
                  <div class="mb-3">
                    <button
                      type="button"
                      id="testAiConfig"
                      class="btn btn-outline-primary btn-sm"
                    >
                      <i class="bi bi-play-circle me-2"></i>测试AI配置
                    </button>
                    <div
                      id="testResult"
                      class="mt-2"
                      style="display: none"
                    ></div>
                  </div>
                </div>

                <!-- 右列：向量搜索配置 -->
                <div class="col-md-6">
                  <h6 class="mb-4">
                    <i class="bi bi-database me-2"></i>向量搜索配置
                  </h6>

                  <!-- 启用向量搜索 -->
                  <div class="mb-4">
                    <div class="form-check form-switch">
                      {{ form.vector_search_enabled(class="form-check-input") }}
                      <label
                        class="form-check-label"
                        for="vector_search_enabled"
                      >
                        {% if settings.vector_search_enabled %}已启用{% else
                        %}未启用{% endif %}向量搜索
                      </label>
                    </div>
                    <div class="form-text">
                      启用后，系统会优先使用向量搜索（如果配置正确），提供更快速和准确的搜索结果
                    </div>
                  </div>

                  <!-- Qdrant 服务地址 -->
                  <div class="mb-3">
                    <label class="form-label fw-bold">Qdrant 服务地址</label>
                    {{ form.qdrant_url(class="form-control",
                    placeholder="http://localhost:6333") }} {% if
                    form.qdrant_url.errors %} {% for error in
                    form.qdrant_url.errors %}
                    <div class="text-danger">{{ error }}</div>
                    {% endfor %} {% endif %}
                    <div class="form-text small">
                      <strong>配置说明：</strong><br />
                      • <strong>Docker部署</strong>：<code
                        >http://qdrant:6333</code
                      ><br />
                      • <strong>本地开发</strong>：<code
                        >http://localhost:6333</code
                      >
                    </div>
                  </div>

                  <!-- Embedding 模型 -->
                  <div class="mb-3">
                    <label class="form-label fw-bold">Embedding 模型</label>
                    {{ form.embedding_model(class="form-control",
                    placeholder="text-embedding-3-small") }} {% if
                    form.embedding_model.errors %} {% for error in
                    form.embedding_model.errors %}
                    <div class="text-danger">{{ error }}</div>
                    {% endfor %} {% endif %}
                    <div class="form-text">
                      用于将文本转换为向量的模型，例如: text-embedding-3-small,
                      bge-large-zh-v1.5
                    </div>
                  </div>

                  <!-- 相似度阈值和最大结果数 -->
                  <div class="row mb-3">
                    <div class="col-6">
                      <label class="form-label fw-bold">相似度阈值</label>
                      {{ form.vector_similarity_threshold(class="form-control",
                      placeholder="0.3", type="number", step="0.1", min="0",
                      max="1") }} {% if form.vector_similarity_threshold.errors
                      %} {% for error in form.vector_similarity_threshold.errors
                      %}
                      <div class="text-danger">{{ error }}</div>
                      {% endfor %} {% endif %}
                      <div class="form-text small">0-1之间，推荐0.3-0.5</div>
                    </div>
                    <div class="col-6">
                      <label class="form-label fw-bold">最大结果数</label>
                      {{ form.vector_max_results(class="form-control",
                      type="number", min="10", max="200") }} {% if
                      form.vector_max_results.errors %} {% for error in
                      form.vector_max_results.errors %}
                      <div class="text-danger">{{ error }}</div>
                      {% endfor %} {% endif %}
                      <div class="form-text small">推荐: 20-50</div>
                    </div>
                  </div>

                  <!-- 向量搜索配置状态提示 -->
                  {% if settings.vector_search_enabled and settings.qdrant_url
                  %}
                  <div class="alert alert-success mb-3">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong>向量搜索已启用</strong>
                    <p class="mb-0 mt-2 small">
                      Qdrant: {{ settings.qdrant_url }}<br />
                      模型: {{ settings.embedding_model or
                      'text-embedding-3-small' }}
                    </p>
                  </div>
                  {% elif settings.vector_search_enabled %}
                  <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>向量搜索配置不完整</strong>
                    <p class="mb-0 mt-2 small">请填写 Qdrant 服务地址</p>
                  </div>
                  {% else %}
                  <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>向量搜索未启用</strong>
                    <p class="mb-0 mt-2 small">启用向量搜索需要：</p>
                    <ul class="mb-0 mt-2 small">
                      <li>启动 Qdrant 服务</li>
                      <li>配置 Qdrant 服务地址</li>
                      <li>确保 AI API 配置正确（用于生成向量）</li>
                    </ul>
                  </div>
                  {% endif %}

                  <!-- 批量生成向量 -->
                  {% if settings.vector_search_enabled and settings.qdrant_url
                  and settings.embedding_model and settings.ai_api_base_url and
                  settings.ai_api_key %}
                  <div class="card border-primary mb-3">
                    <div class="card-header bg-primary text-white">
                      <i class="bi bi-database-add me-2"></i>批量生成向量索引
                    </div>
                    <div class="card-body">
                      <p class="card-text small mb-3">
                        为数据库中所有网站生成向量索引，用于向量搜索功能。首次使用或更换模型后需要执行此操作。
                      </p>

                      <div id="vectorIndexingStatus" style="display: none">
                        <div class="mb-3">
                          <div
                            class="d-flex justify-content-between align-items-center mb-2"
                          >
                            <span class="small">生成进度</span>
                            <span class="small" id="vectorIndexingPercent"
                              >0%</span
                            >
                          </div>
                          <div class="progress" style="height: 20px">
                            <div
                              class="progress-bar progress-bar-striped progress-bar-animated"
                              role="progressbar"
                              id="vectorIndexingProgress"
                              style="width: 0%"
                            ></div>
                          </div>
                        </div>
                        <div class="row text-center mb-3">
                          <div class="col-3">
                            <div class="small text-muted">总数</div>
                            <div class="fw-bold" id="vectorIndexingTotal">
                              0
                            </div>
                          </div>
                          <div class="col-3">
                            <div class="small text-muted">已处理</div>
                            <div
                              class="fw-bold text-primary"
                              id="vectorIndexingProcessed"
                            >
                              0
                            </div>
                          </div>
                          <div class="col-3">
                            <div class="small text-muted">成功</div>
                            <div
                              class="fw-bold text-success"
                              id="vectorIndexingSuccess"
                            >
                              0
                            </div>
                          </div>
                          <div class="col-3">
                            <div class="small text-muted">失败</div>
                            <div
                              class="fw-bold text-danger"
                              id="vectorIndexingFailed"
                            >
                              0
                            </div>
                          </div>
                        </div>
                        <div class="small text-muted mb-2">
                          <i class="bi bi-clock me-1"></i>已用时间:
                          <span id="vectorIndexingElapsed">0秒</span>
                        </div>
                      </div>

                      <div class="d-flex gap-2">
                        <button
                          type="button"
                          id="startVectorIndexing"
                          class="btn btn-primary btn-sm"
                        >
                          <i class="bi bi-play-circle me-2"></i>开始生成
                        </button>
                        <button
                          type="button"
                          id="stopVectorIndexing"
                          class="btn btn-outline-danger btn-sm"
                          style="display: none"
                        >
                          <i class="bi bi-stop-circle me-2"></i>停止
                        </button>
                        <div
                          class="form-check form-switch align-self-center ms-auto"
                        >
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="skipExistingVectors"
                            checked
                          />
                          <label
                            class="form-check-label small"
                            for="skipExistingVectors"
                          >
                            跳过已存在的向量
                          </label>
                        </div>
                      </div>
                      <div id="vectorIndexingMessage" class="mt-2 small"></div>
                    </div>
                  </div>
                  {% endif %}
                </div>
              </div>

              <!-- 提示信息 -->
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                <strong>使用说明：</strong>
                <ul class="mb-0 mt-2">
                  <li>支持OpenAI API及兼容OpenAI API格式的服务</li>
                  <li>API密钥已配置时会显示为掩码格式（留空则不修改）</li>
                  <li>配置完成后，用户可以在搜索框启用AI搜索</li>
                  <li>AI搜索失败时会自动回退到传统搜索</li>
                  <li>
                    <strong>向量搜索</strong
                    >：启用后优先使用向量搜索，性能更优，支持大规模数据
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4 text-end">
        {{ form.submit_btn(class="btn btn-primary btn-lg px-5") }}
      </div>
    </form>
  </div>
</div>
{% endblock %} {% block admin_scripts %}
<script>
  // 实时预览Logo和网站标题
  document.addEventListener("DOMContentLoaded", function () {
    const siteNameInput = document.getElementById("site_name");
    const logoUrlInput = document.getElementById("site_logo");
    const logoFileInput = document.getElementById("logo_file");
    const faviconUrlInput = document.getElementById("site_favicon");
    const faviconFileInput = document.getElementById("favicon_file");
    const clearButtons = document.querySelectorAll(".clear-input");

    // 背景设置相关
    const bgTypeSelect = document.getElementById("background_type");
    const bgUrlInput = document.getElementById("background_url");
    const bgFileInput = document.getElementById("background_file");
    const bgUrlContainer = document.getElementById("bgUrlContainer");
    const bgUploadContainer = document.getElementById("bgUploadContainer");
    const bgUrlHelp = document.getElementById("bgUrlHelp");
    const bgPreview = document.getElementById("bgPreview");

    // 在页面加载时同步表单状态与预览
    function syncFormAndPreviewState() {
      // 检查会话存储中是否有清空标记
      if (typeof Storage !== "undefined") {
        if (
          sessionStorage.getItem("site_logo_cleared") === "true" &&
          logoUrlInput
        ) {
          logoUrlInput.value = "";
          if (logoFileInput) logoFileInput.value = "";

          const logoPreview = document.querySelector(".site-logo-preview");
          if (logoPreview) {
            logoPreview.innerHTML = `
              <div class="text-center p-3 bg-light rounded">
                <i class="bi bi-collection"></i> 默认Logo
              </div>
            `;
          }
        }

        if (
          sessionStorage.getItem("site_favicon_cleared") === "true" &&
          faviconUrlInput
        ) {
          faviconUrlInput.value = "";
          if (faviconFileInput) faviconFileInput.value = "";

          const faviconPreview = document.querySelector(".favicon-preview");
          if (faviconPreview) {
            faviconPreview.innerHTML = `
              <div class="text-center p-3 bg-light rounded" style="width: 32px; height: 32px">
                <i class="bi bi-globe" style="font-size: 16px"></i>
              </div>
            `;
          }
        }
      }

      // 检查Logo状态
      if (logoUrlInput && !logoUrlInput.value) {
        const logoPreview = document.querySelector(".site-logo-preview");
        if (logoPreview) {
          logoPreview.innerHTML = `
            <div class="text-center p-3 bg-light rounded">
              <i class="bi bi-collection"></i> 默认Logo
            </div>
          `;
        }
      }

      // 检查Favicon状态
      if (faviconUrlInput && !faviconUrlInput.value) {
        const faviconPreview = document.querySelector(".favicon-preview");
        if (faviconPreview) {
          faviconPreview.innerHTML = `
            <div class="text-center p-3 bg-light rounded" style="width: 32px; height: 32px">
              <i class="bi bi-globe" style="font-size: 16px"></i>
            </div>
          `;
        }
      }
    }

    // 在页面加载时执行同步
    syncFormAndPreviewState();

    // 监听表单提交事件，清除会话存储
    const form = document.querySelector("form");
    if (form) {
      form.addEventListener("submit", function () {
        if (typeof Storage !== "undefined") {
          sessionStorage.removeItem("site_logo_cleared");
          sessionStorage.removeItem("site_favicon_cleared");
        }
      });
    }

    // 处理清空按钮点击事件
    clearButtons.forEach((button) => {
      button.addEventListener("click", function () {
        // 获取目标输入框ID和预览容器类名
        const targetId = this.getAttribute("data-target");
        const previewClass = this.getAttribute("data-preview");

        // 清空输入框
        const inputElement = document.getElementById(targetId);
        if (inputElement) {
          inputElement.value = "";

          // 同时清空相关的文件输入控件
          if (targetId === "site_logo" && logoFileInput) {
            logoFileInput.value = "";
            // 设置清空标记
            document.getElementById("clear_logo_field").value = "1";
          } else if (targetId === "site_favicon" && faviconFileInput) {
            faviconFileInput.value = "";
            // 设置清空标记
            document.getElementById("clear_favicon_field").value = "1";
          }

          // 恢复默认预览
          const previewContainer = document.querySelector("." + previewClass);
          if (previewContainer) {
            // 移除当前预览的图片
            const currentImg = previewContainer.querySelector("img");
            if (currentImg) {
              currentImg.remove();
            }

            // 添加默认图标
            if (previewClass === "site-logo-preview") {
              previewContainer.innerHTML = `
                <div class="text-center p-3 bg-light rounded">
                  <i class="bi bi-collection"></i> 默认Logo
                </div>
              `;
            } else if (previewClass === "favicon-preview") {
              previewContainer.innerHTML = `
                <div class="text-center p-3 bg-light rounded" style="width: 32px; height: 32px">
                  <i class="bi bi-globe" style="font-size: 16px"></i>
                </div>
              `;
            }
          }
        }

        // 防止浏览器缓存，将表单值提交到会话存储中
        if (typeof Storage !== "undefined") {
          sessionStorage.setItem(targetId + "_cleared", "true");
        }

        // 创建确认对话框
        if (confirm("是否立即保存此更改？")) {
          // 自动提交表单
          document.querySelector("form").submit();
        }
      });
    });

    // 图片预览功能
    function handleFilePreview(fileInput, urlInput, previewContainer) {
      if (!fileInput) return;

      fileInput.addEventListener("change", function () {
        if (this.files && this.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            let previewImg = previewContainer.querySelector("img");
            if (!previewImg) {
              previewContainer.innerHTML = "";
              previewImg = document.createElement("img");
              previewImg.style.maxHeight = previewContainer.classList.contains(
                "favicon-preview"
              )
                ? "32px"
                : "50px";
              previewContainer.appendChild(previewImg);
            }
            previewImg.src = e.target.result;

            // 添加错误处理，如果图片加载失败，显示默认图标
            previewImg.onerror = function () {
              showDefaultIcon(previewContainer);
            };
          };
          reader.readAsDataURL(this.files[0]);
        }
      });
    }

    // URL输入预览
    function handleUrlPreview(urlInput, previewContainer) {
      if (!urlInput) return;

      urlInput.addEventListener("input", function () {
        if (this.value) {
          let previewImg = previewContainer.querySelector("img");
          if (!previewImg) {
            previewContainer.innerHTML = "";
            previewImg = document.createElement("img");
            previewImg.style.maxHeight = previewContainer.classList.contains(
              "favicon-preview"
            )
              ? "32px"
              : "50px";
            previewContainer.appendChild(previewImg);
          }
          previewImg.src = this.value;

          // 添加错误处理，如果图片加载失败，显示默认图标
          previewImg.onerror = function () {
            showDefaultIcon(previewContainer);
          };
        } else {
          // 如果URL为空，显示默认图标
          showDefaultIcon(previewContainer);
        }
      });
    }

    // 显示默认图标
    function showDefaultIcon(container) {
      if (container.classList.contains("site-logo-preview")) {
        container.innerHTML = `
          <div class="text-center p-3 bg-light rounded">
            <i class="bi bi-collection"></i> 默认Logo
          </div>
        `;
      } else if (container.classList.contains("favicon-preview")) {
        container.innerHTML = `
          <div class="text-center p-3 bg-light rounded" style="width: 32px; height: 32px">
            <i class="bi bi-globe" style="font-size: 16px"></i>
          </div>
        `;
      }
    }

    // 初始化预览功能
    handleFilePreview(
      logoFileInput,
      logoUrlInput,
      document.querySelector(".site-logo-preview")
    );
    handleFilePreview(
      faviconFileInput,
      faviconUrlInput,
      document.querySelector(".favicon-preview")
    );
    handleUrlPreview(
      logoUrlInput,
      document.querySelector(".site-logo-preview")
    );
    handleUrlPreview(
      faviconUrlInput,
      document.querySelector(".favicon-preview")
    );

    // 背景类型变化处理
    if (bgTypeSelect) {
      // 初始化时根据当前值设置
      updateBackgroundUI(bgTypeSelect.value);

      bgTypeSelect.addEventListener("change", function () {
        updateBackgroundUI(this.value);
      });

      // 背景文件上传预览
      if (bgFileInput) {
        bgFileInput.addEventListener("change", function () {
          if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
              bgPreview.innerHTML = "";
              bgPreview.style.backgroundImage = `url(${e.target.result})`;
              bgPreview.style.backgroundSize = "cover";
              bgPreview.style.backgroundPosition = "center";
              bgPreview.style.height = "150px";
              bgPreview.style.width = "100%";
            };
            reader.readAsDataURL(this.files[0]);
          }
        });
      }

      // 背景URL预览
      if (bgUrlInput) {
        bgUrlInput.addEventListener("input", function () {
          updateBackgroundPreview(this.value, bgTypeSelect.value);
        });

        // 初始预览
        if (bgUrlInput.value) {
          updateBackgroundPreview(bgUrlInput.value, bgTypeSelect.value);
        }
      }
    }

    // 更新背景UI显示
    function updateBackgroundUI(type) {
      // 显示/隐藏相关字段
      if (type === "none") {
        bgUrlContainer.style.display = "none";
        bgUploadContainer.style.display = "none";

        // 重置预览
        bgPreview.style.backgroundImage = "";
        bgPreview.style.backgroundColor = "";
        bgPreview.innerHTML = '<p class="mb-0">无背景</p>';
      } else {
        bgUrlContainer.style.display = "block";

        if (type === "image") {
          bgUploadContainer.style.display = "block";
          bgUrlHelp.textContent = "背景图片URL";
        } else {
          bgUploadContainer.style.display = "none";

          if (type === "gradient") {
            bgUrlHelp.textContent =
              "渐变色代码，例如：linear-gradient(135deg, #6e8efb, #a777e3)";
          } else if (type === "color") {
            bgUrlHelp.textContent =
              "颜色代码，例如：#f5f7fa 或 rgba(245, 247, 250, 1)";
          }
        }

        // 如果有当前值，更新预览
        if (bgUrlInput.value) {
          updateBackgroundPreview(bgUrlInput.value, type);
        }
      }
    }

    // 更新背景预览
    function updateBackgroundPreview(value, type) {
      if (!value) {
        bgPreview.style.backgroundImage = "";
        bgPreview.style.backgroundColor = "";
        bgPreview.innerHTML = '<p class="mb-0">背景预览</p>';
        return;
      }

      bgPreview.innerHTML = "";

      if (type === "image") {
        bgPreview.style.backgroundImage = `url(${value})`;
        bgPreview.style.backgroundSize = "cover";
        bgPreview.style.backgroundPosition = "center";
        bgPreview.style.backgroundColor = "";
      } else if (type === "gradient") {
        bgPreview.style.backgroundImage = value;
        bgPreview.style.backgroundColor = "";
      } else if (type === "color") {
        bgPreview.style.backgroundImage = "";
        bgPreview.style.backgroundColor = value;
      }

      bgPreview.style.height = "150px";
      bgPreview.style.width = "100%";
    }

    // ========== PC端与移动端壁纸预览 ========== //
    // PC端
    const pcTypeSelect = document.getElementById("pc_background_type");
    const pcUrlInput = document.getElementById("pc_background_url");
    const pcFileInput = document.getElementById("pc_background_file");
    const pcPreview = document.getElementById("pcBgPreview");
    // 移动端
    const mobileTypeSelect = document.getElementById("mobile_background_type");
    const mobileUrlInput = document.getElementById("mobile_background_url");
    const mobileFileInput = document.getElementById("mobile_background_file");
    const mobilePreview = document.getElementById("mobileBgPreview");

    // 预览更新函数
    function updateDeviceBgPreview(type, value, preview) {
      preview.innerHTML = "";
      if (!value || type === "none") {
        preview.style.backgroundImage = "";
        preview.style.backgroundColor = "";
        preview.innerHTML = '<p class="mb-0">背景预览</p>';
        return;
      }
      if (type === "image") {
        preview.style.backgroundImage = `url(${value})`;
        preview.style.backgroundSize = "cover";
        preview.style.backgroundPosition = "center";
        preview.style.backgroundColor = "";
      } else if (type === "gradient") {
        preview.style.backgroundImage = value;
        preview.style.backgroundColor = "";
      } else if (type === "color") {
        preview.style.backgroundImage = "";
        preview.style.backgroundColor = value;
      }
      preview.style.height = "120px";
      preview.style.width = "100%";
    }

    // 绑定PC端事件
    if (pcTypeSelect && pcUrlInput && pcPreview) {
      function syncPcPreview() {
        updateDeviceBgPreview(pcTypeSelect.value, pcUrlInput.value, pcPreview);
      }
      pcTypeSelect.addEventListener("change", syncPcPreview);
      pcUrlInput.addEventListener("input", syncPcPreview);
      // 文件上传
      if (pcFileInput) {
        pcFileInput.addEventListener("change", function () {
          if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
              updateDeviceBgPreview("image", e.target.result, pcPreview);
            };
            reader.readAsDataURL(this.files[0]);
          }
        });
      }
      // 初始预览
      syncPcPreview();
    }

    // AI配置测试
    const testAiConfigBtn = document.getElementById("testAiConfig");
    const testResultDiv = document.getElementById("testResult");
    if (testAiConfigBtn) {
      testAiConfigBtn.addEventListener("click", function () {
        const apiBaseUrl = document
          .getElementById("ai_api_base_url")
          .value.trim();
        const apiKeyInput = document.getElementById("ai_api_key").value.trim();
        const modelName = document.getElementById("ai_model_name").value.trim();

        // 如果输入框为空或包含*号（掩码），说明使用数据库中的配置
        // 允许测试，后端会使用数据库中的真实key
        if (!apiBaseUrl || !modelName) {
          testResultDiv.innerHTML =
            '<div class="alert alert-warning">请先填写API基础URL和模型名称</div>';
          testResultDiv.style.display = "block";
          return;
        }

        // 如果apiKey输入框为空或包含*号，说明是掩码，后端会使用数据库中的真实key
        // 如果输入了新key，则使用输入的key进行测试

        testAiConfigBtn.disabled = true;
        testAiConfigBtn.innerHTML =
          '<i class="bi bi-hourglass-split me-2"></i>测试中...';
        testResultDiv.innerHTML =
          '<div class="alert alert-info">正在测试AI配置...</div>';
        testResultDiv.style.display = "block";

        // 获取CSRF token
        const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
        const csrfToken = csrfTokenMeta
          ? csrfTokenMeta.getAttribute("content")
          : "";

        fetch("{{ url_for('admin.test_ai_config') }}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken,
          },
          body: JSON.stringify({
            api_base_url: apiBaseUrl,
            api_key: apiKeyInput, // 可能是掩码或新key，后端会判断
            model_name: modelName,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              testResultDiv.innerHTML =
                '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>' +
                data.message +
                "</div>";
            } else {
              testResultDiv.innerHTML =
                '<div class="alert alert-danger"><i class="bi bi-x-circle me-2"></i>' +
                data.message +
                "</div>";
            }
          })
          .catch((error) => {
            testResultDiv.innerHTML =
              '<div class="alert alert-danger"><i class="bi bi-x-circle me-2"></i>测试失败: ' +
              error.message +
              "</div>";
          })
          .finally(() => {
            testAiConfigBtn.disabled = false;
            testAiConfigBtn.innerHTML =
              '<i class="bi bi-play-circle me-2"></i>测试AI配置';
          });
      });
    }

    // 绑定移动端事件
    if (mobileTypeSelect && mobileUrlInput && mobilePreview) {
      function syncMobilePreview() {
        updateDeviceBgPreview(
          mobileTypeSelect.value,
          mobileUrlInput.value,
          mobilePreview
        );
      }
      mobileTypeSelect.addEventListener("change", syncMobilePreview);
      mobileUrlInput.addEventListener("input", syncMobilePreview);
      // 文件上传
      if (mobileFileInput) {
        mobileFileInput.addEventListener("change", function () {
          if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
              updateDeviceBgPreview("image", e.target.result, mobilePreview);
            };
            reader.readAsDataURL(this.files[0]);
          }
        });
      }
      // 初始预览
      syncMobilePreview();
    }

    // 批量生成向量功能
    const startVectorIndexingBtn = document.getElementById(
      "startVectorIndexing"
    );
    const stopVectorIndexingBtn = document.getElementById("stopVectorIndexing");
    const vectorIndexingStatus = document.getElementById(
      "vectorIndexingStatus"
    );
    const vectorIndexingMessage = document.getElementById(
      "vectorIndexingMessage"
    );
    const skipExistingVectors = document.getElementById("skipExistingVectors");

    if (startVectorIndexingBtn) {
      let statusCheckInterval = null;

      // 开始生成向量
      startVectorIndexingBtn.addEventListener("click", function () {
        const skipExisting = skipExistingVectors
          ? skipExistingVectors.checked
          : true;

        // 获取CSRF token
        const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
        const csrfToken = csrfTokenMeta
          ? csrfTokenMeta.getAttribute("content")
          : "";

        fetch("{{ url_for('admin.batch_generate_vectors') }}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken,
          },
          body: JSON.stringify({
            skip_existing: skipExisting,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              startVectorIndexingBtn.style.display = "none";
              stopVectorIndexingBtn.style.display = "inline-block";
              vectorIndexingStatus.style.display = "block";
              vectorIndexingMessage.innerHTML =
                '<div class="alert alert-info mb-0"><i class="bi bi-info-circle me-2"></i>' +
                data.message +
                "</div>";

              // 开始轮询状态
              statusCheckInterval = setInterval(
                checkVectorIndexingStatus,
                1000
              );
              checkVectorIndexingStatus();
            } else {
              vectorIndexingMessage.innerHTML =
                '<div class="alert alert-danger mb-0"><i class="bi bi-x-circle me-2"></i>' +
                data.message +
                "</div>";
            }
          })
          .catch((error) => {
            vectorIndexingMessage.innerHTML =
              '<div class="alert alert-danger mb-0"><i class="bi bi-x-circle me-2"></i>启动失败: ' +
              error.message +
              "</div>";
          });
      });

      // 停止生成向量
      if (stopVectorIndexingBtn) {
        stopVectorIndexingBtn.addEventListener("click", function () {
          const csrfTokenMeta = document.querySelector(
            'meta[name="csrf-token"]'
          );
          const csrfToken = csrfTokenMeta
            ? csrfTokenMeta.getAttribute("content")
            : "";

          fetch("{{ url_for('admin.batch_generate_vectors_stop') }}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken,
            },
          })
            .then((response) => response.json())
            .then((data) => {
              vectorIndexingMessage.innerHTML =
                '<div class="alert alert-warning mb-0"><i class="bi bi-exclamation-triangle me-2"></i>' +
                data.message +
                "</div>";
            })
            .catch((error) => {
              vectorIndexingMessage.innerHTML =
                '<div class="alert alert-danger mb-0"><i class="bi bi-x-circle me-2"></i>停止失败: ' +
                error.message +
                "</div>";
            });
        });
      }

      // 检查生成状态
      function checkVectorIndexingStatus() {
        fetch("{{ url_for('admin.batch_generate_vectors_status') }}")
          .then((response) => response.json())
          .then((data) => {
            // 更新进度条
            const progressBar = document.getElementById(
              "vectorIndexingProgress"
            );
            const percentEl = document.getElementById("vectorIndexingPercent");
            if (progressBar) {
              progressBar.style.width = data.percent + "%";
            }
            if (percentEl) {
              percentEl.textContent = data.percent + "%";
            }

            // 更新统计信息
            const totalEl = document.getElementById("vectorIndexingTotal");
            const processedEl = document.getElementById(
              "vectorIndexingProcessed"
            );
            const successEl = document.getElementById("vectorIndexingSuccess");
            const failedEl = document.getElementById("vectorIndexingFailed");
            const elapsedEl = document.getElementById("vectorIndexingElapsed");

            if (totalEl) totalEl.textContent = data.total || 0;
            if (processedEl) processedEl.textContent = data.processed || 0;
            if (successEl) successEl.textContent = data.success || 0;
            if (failedEl) failedEl.textContent = data.failed || 0;
            if (elapsedEl) elapsedEl.textContent = data.elapsed_time || "0秒";

            // 如果任务完成，停止轮询
            if (!data.is_running) {
              if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
              }

              startVectorIndexingBtn.style.display = "inline-block";
              stopVectorIndexingBtn.style.display = "none";

              const skippedText =
                data.skipped > 0 ? `，跳过: ${data.skipped}` : "";
              vectorIndexingMessage.innerHTML =
                '<div class="alert alert-success mb-0">' +
                '<i class="bi bi-check-circle me-2"></i>' +
                `生成完成！成功: ${data.success}，失败: ${data.failed}${skippedText}，总计: ${data.total}` +
                "</div>";
            }
          })
          .catch((error) => {
            console.error("检查状态失败:", error);
          });
      }
    }
  });

  // 控制"允许非登录用户使用AI搜索"开关的启用/禁用状态
  const aiSearchEnabled = document.getElementById("ai_search_enabled");
  const aiSearchAllowAnonymous = document.getElementById(
    "ai_search_allow_anonymous"
  );

  function updateAnonymousToggleState() {
    if (aiSearchEnabled && aiSearchAllowAnonymous) {
      if (!aiSearchEnabled.checked) {
        // AI搜索未启用时，禁用并取消选中"允许非登录用户使用AI搜索"
        aiSearchAllowAnonymous.disabled = true;
        aiSearchAllowAnonymous.checked = false;
      } else {
        // AI搜索启用时，允许操作"允许非登录用户使用AI搜索"
        aiSearchAllowAnonymous.disabled = false;
      }
    }
  }

  // 页面加载时设置初始状态
  if (aiSearchEnabled) {
    updateAnonymousToggleState();
    // 监听"启用AI搜索"开关的变化
    aiSearchEnabled.addEventListener("change", updateAnonymousToggleState);
  }
</script>
{% endblock %}
